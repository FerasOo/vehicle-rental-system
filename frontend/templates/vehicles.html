{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Vehicles</h1>
        <div id="employee-actions" class="hidden">
            <button onclick="showAddVehicleModal()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Add Vehicle
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
        <h2 class="text-lg font-semibold mb-4">Filters</h2>
        <form id="filterForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1">Vehicle Type</label>
                <select name="vehicle_type" class="w-full p-2 border rounded">
                    <option value="">All Types</option>
                    <option value="CAR">Car</option>
                    <option value="MOTORCYCLE">Motorcycle</option>
                    <option value="VAN">Van</option>
                    <option value="TRUCK">Truck</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Price Range</label>
                <div class="flex gap-2">
                    <input type="number" name="min_price" placeholder="Min" class="w-full p-2 border rounded">
                    <input type="number" name="max_price" placeholder="Max" class="w-full p-2 border rounded">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Location</label>
                <input type="text" name="location" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Availability</label>
                <select name="availability_status" class="w-full p-2 border rounded">
                    <option value="">All</option>
                    <option value="AVAILABLE">Available</option>
                    <option value="RENTED">Rented</option>
                    <option value="MAINTENANCE">Maintenance</option>
                </select>
            </div>
            <div class="md:col-span-4">
                <button type="submit" 
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Vehicles Grid -->
    <div id="vehicles-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Vehicles will be loaded here dynamically -->
    </div>
</div>

<!-- Add/Edit Vehicle Modal -->
<div id="vehicleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-full max-w-md">
        <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Vehicle</h2>
        <form id="vehicleForm">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Vehicle ID</label>
                <input type="text" name="vehicle_id" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Type</label>
                <select name="vehicle_type" class="w-full p-2 border rounded" required>
                    <option value="CAR">Car</option>
                    <option value="MOTORCYCLE">Motorcycle</option>
                    <option value="VAN">Van</option>
                    <option value="TRUCK">Truck</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Model</label>
                <input type="text" name="model" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Price per Day</label>
                <input type="number" name="rental_price_per_day" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Location</label>
                <input type="text" name="location" class="w-full p-2 border rounded" required>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeModal()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button type="submit" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentUser = null;
let isEmployee = false;

// Initialize page
async function initializePage() {
    const token = localStorage.getItem('token');
    if (token) {
        try {
            const response = await fetch('/api/users/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            currentUser = await response.json();
            isEmployee = currentUser.role === 'EMPLOYEE';
            if (isEmployee) {
                document.getElementById('employee-actions').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error fetching user:', error);
        }
    }
    loadVehicles();
}

// Load vehicles with filters
async function loadVehicles() {
    const formData = new FormData(document.getElementById('filterForm'));
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }

    try {
        const response = await fetch(`/api/vehicles/?${params}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        const vehicles = await response.json();
        displayVehicles(vehicles);
    } catch (error) {
        showNotification('Error loading vehicles', 'error');
    }
}

// Display vehicles in grid
function displayVehicles(vehicles) {
    const grid = document.getElementById('vehicles-grid');
    grid.innerHTML = vehicles.map(vehicle => `
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2">${vehicle.model}</h3>
            <p class="text-gray-600">Type: ${vehicle.vehicle_type}</p>
            <p class="text-gray-600">Location: ${vehicle.location}</p>
            <p class="text-gray-600">Price: $${vehicle.rental_price_per_day}/day</p>
            <p class="text-gray-600">Status: ${vehicle.availability_status}</p>
            <div class="mt-4 flex gap-2">
                ${vehicle.availability_status === 'AVAILABLE' && !isEmployee ? 
                    `<button onclick="rentVehicle('${vehicle.vehicle_id}')" 
                             class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Rent
                    </button>` : ''}
                ${isEmployee ? `
                    <button onclick="editVehicle('${vehicle.vehicle_id}')" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Edit
                    </button>
                    <button onclick="deleteVehicle('${vehicle.vehicle_id}')" 
                            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Delete
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// Event Listeners
document.getElementById('filterForm').addEventListener('submit', (e) => {
    e.preventDefault();
    loadVehicles();
});

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', initializePage);

function showAddVehicleModal() {
    document.getElementById('modalTitle').textContent = 'Add Vehicle';
    document.getElementById('vehicleForm').reset();
    document.getElementById('vehicleModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('vehicleModal').classList.add('hidden');
}

async function editVehicle(vehicleId) {
    try {
        const response = await fetch(`/api/vehicles/${vehicleId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        const vehicle = await response.json();
        
        document.getElementById('modalTitle').textContent = 'Edit Vehicle';
        const form = document.getElementById('vehicleForm');
        // Populate form fields
        Object.keys(vehicle).forEach(key => {
            if (form.elements[key]) {
                form.elements[key].value = vehicle[key];
            }
        });
        document.getElementById('vehicleModal').classList.remove('hidden');
    } catch (error) {
        showNotification('Error loading vehicle details', 'error');
    }
}

async function deleteVehicle(vehicleId) {
    if (confirm('Are you sure you want to delete this vehicle?')) {
        try {
            await fetch(`/api/vehicles/${vehicleId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            showNotification('Vehicle deleted successfully', 'success');
            loadVehicles();
        } catch (error) {
            showNotification('Error deleting vehicle', 'error');
        }
    }
}

async function rentVehicle(vehicleId) {
    try {
        const response = await fetch('/api/rentals/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vehicle_id: vehicleId,
                // You might want to add a date picker for these
                start_date: new Date().toISOString(),
                end_date: new Date(Date.now() + 86400000).toISOString() // +1 day
            })
        });
        
        if (response.ok) {
            showNotification('Vehicle rented successfully', 'success');
            loadVehicles();
        } else {
            const error = await response.json();
            showNotification(error.detail || 'Error renting vehicle', 'error');
        }
    } catch (error) {
        showNotification('Error renting vehicle', 'error');
    }
}

</script>
{% endblock %} 